<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Chi ti·∫øt giao h√†ng</title>
<link rel="stylesheet" th:href="@{/css/shipper.css}">
<style>
.upload-preview {
    margin-top: 10px;
    max-width: 300px;
}
.upload-preview img {
    width: 100%;
    border-radius: 8px;
    border: 2px solid #ddd;
}
.camera-button {
    display: inline-block;
    padding: 10px 20px;
    background: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    margin-bottom: 10px;
}
.camera-button:hover {
    background: #45a049;
}
</style>
</head>
<body>
<div th:replace="~{fragments/shipper-header :: header}"></div>
<div class="container">
<div class="page-header">
<h1>Chi ti·∫øt giao h√†ng</h1>
<a th:href="@{/shipper/shipments}" class="btn-secondary">Quay l·∫°i</a>
</div>
<div th:if="${success}" class="alert success" th:text="${success}"></div>
<div th:if="${error}" class="alert error" th:text="${error}"></div>

<div class="shipment-status-card">
<h2>
M√£ giao h√†ng: <span th:text="${shipment.shipmentCode}"></span>
</h2>
<p class="status-large">
<span th:class="'badge badge-' + ${shipment.status} + ' badge-lg'"
th:text="${shipment.status}"></span>
</p>
</div>

<div class="detail-grid">
<div class="detail-card">
<h3>Th√¥ng tin ƒë∆°n h√†ng</h3>
<p>
<strong>M√£ ƒë∆°n:</strong> <span
th:text="${shipment.order.orderCode}"></span>
</p>
<p>
<strong>Ng∆∞·ªùi g·ª≠i:</strong> <span
th:text="${shipment.order.senderName}"></span>
</p>
<p>
<strong>Ng∆∞·ªùi nh·∫≠n:</strong> <span
th:text="${shipment.order.recipientName}"></span>
</p>
<p>
<strong>SƒêT nh·∫≠n:</strong> 
th:href="'tel:' + ${shipment.order.recipientPhone}"
th:text="${shipment.order.recipientPhone}"></a>
</p>
<p>
<strong>ƒê·ªãa ch·ªâ:</strong> <span
th:text="${shipment.order.recipientAddress}"></span>
</p>
</div>

<div class="detail-card">
<h3>Th√¥ng tin giao h√†ng</h3>
<p th:if="${shipment.pickupTime}">
<strong>L·∫•y h√†ng:</strong> <span
th:text="${#temporals.format(shipment.pickupTime, 'dd/MM/yyyy HH:mm')}"></span>
</p>
<p th:if="${shipment.deliveryTime}">
<strong>Giao h√†ng:</strong> <span
th:text="${#temporals.format(shipment.deliveryTime, 'dd/MM/yyyy HH:mm')}"></span>
</p>
<p th:if="${shipment.notes}">
<strong>Ghi ch√∫:</strong> <span th:text="${shipment.notes}"></span>
</p>
<p th:if="${shipment.proofImageUrl}">
<strong>·∫¢nh ch·ª©ng t·ª´:</strong><br> <img
th:src="${shipment.proofImageUrl}" alt="Proof"
style="max-width: 300px; margin-top: 10px; border-radius: 8px;">
</p>
</div>
</div>

<div class="action-section"
th:if="${shipment.status == T(ltweb.entity.ShipmentStatus).PENDING}">
<h3>Nh·∫≠n h√†ng v√† b·∫Øt ƒë·∫ßu v·∫≠n chuy·ªÉn</h3>

<form
th:action="@{/shipper/shipments/{id}/receive(id=${shipment.id})}"
method="post" style="display: inline-block; margin-right: 10px;">
<button type="submit" class="btn-primary">X√°c nh·∫≠n nh·∫≠n h√†ng</button>
</form>

<form th:action="@{/shipper/shipments/{id}/start(id=${shipment.id})}"
method="post" style="display: inline-block;">
<button type="submit" class="btn-success btn-lg">B·∫Øt ƒë·∫ßu v·∫≠n chuy·ªÉn</button>
</form>
</div>

<div class="action-section"
th:if="${shipment.status == T(ltweb.entity.ShipmentStatus).IN_TRANSIT}">
<h3>Ho√†n th√†nh giao h√†ng</h3>
<form
th:action="@{/shipper/shipments/{id}/complete(id=${shipment.id})}"
method="post" enctype="multipart/form-data" class="action-form" id="completeForm">
<div class="form-group">
<label>·∫¢nh ch·ª©ng t·ª´ giao h√†ng *</label>
<button type="button" class="camera-button" onclick="document.getElementById('proofImageInput').click()">
üì∑ Ch·ª•p ·∫£nh / Ch·ªçn ·∫£nh
</button>
<input type="file" id="proofImageInput" name="proofImage" 
accept="image/*" capture="environment" style="display: none;" 
onchange="previewImage(this)" required>
<div id="imagePreview" class="upload-preview"></div>
</div>
<div class="form-group">
<label>Ghi ch√∫</label>
<textarea name="notes" rows="3"
placeholder="Ghi ch√∫ v·ªÅ vi·ªác giao h√†ng..."></textarea>
</div>
<button type="submit" class="btn-success btn-lg">Ho√†n th√†nh giao h√†ng</button>
</form>
</div>

<div class="section"
th:if="${shipment.status == T(ltweb.entity.ShipmentStatus).IN_TRANSIT}">
<h3>C·∫≠p nh·∫≠t v·ªã tr√≠</h3>
<button onclick="updateLocation()" class="btn-primary">C·∫≠p nh·∫≠t v·ªã tr√≠ hi·ªán t·∫°i</button>
<div id="location-status" class="mt-2"></div>
</div>
</div>
<script th:inline="javascript">
const shipmentId = /*[[${shipment.id}]]*/ 0;

function previewImage(input) {
    const preview = document.getElementById('imagePreview');
    
    if (input.files && input.files[0]) {
        const reader = new FileReader();
        
        reader.onload = function(e) {
            preview.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <p style="color: green; margin-top: 5px;">‚úì ƒê√£ ch·ªçn ·∫£nh</p>
            `;
        }
        
        reader.readAsDataURL(input.files[0]);
    }
}

document.getElementById('completeForm').addEventListener('submit', function(e) {
    const fileInput = document.getElementById('proofImageInput');
    if (!fileInput.files || !fileInput.files[0]) {
        e.preventDefault();
        alert('Vui l√≤ng ch·ª•p ho·∫∑c ch·ªçn ·∫£nh ch·ª©ng t·ª´ giao h√†ng!');
        return false;
    }
});

function updateLocation() {
if (navigator.geolocation) {
navigator.geolocation.getCurrentPosition(function(position) {
const data = new FormData();
data.append('latitude', position.coords.latitude);
data.append('longitude', position.coords.longitude);

fetch('/shipper/location/update', {
method: 'POST',
body: data
})
.then(response => response.text())
.then(result => {
document.getElementById('location-status').innerHTML =
'<span class="text-success">‚úì ƒê√£ c·∫≠p nh·∫≠t v·ªã tr√≠</span>';
})
.catch(error => {
document.getElementById('location-status').innerHTML =
'<span class="text-danger">‚úó L·ªói c·∫≠p nh·∫≠t</span>';
});
}, function(error) {
alert('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠: ' + error.message);
});
} else {
alert('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã');
}
}
</script>
</body>
</html>