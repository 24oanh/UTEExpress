<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Dashboard - Shipper</title>
    <link rel="stylesheet" th:href="@{/css/shipper.css}">
</head>
<body>
<div th:replace="~{fragments/shipper-header :: header}"></div>

<div class="container">
    <h1>Dashboard</h1>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>ƒê∆°n ƒë∆∞·ª£c giao</h3>
            <p class="stat-number" th:text="${assignedOrders.size()}">0</p>
        </div>
        <div class="stat-card">
            <h3>Ch·ªù l·∫•y h√†ng</h3>
            <p class="stat-number" th:text="${pendingShipments.size()}">0</p>
        </div>
        <div class="stat-card">
            <h3>ƒêang giao</h3>
            <p class="stat-number" th:text="${inTransitShipments.size()}">0</p>
        </div>
        <div class="stat-card">
            <h3>T·ªïng giao</h3>
            <p class="stat-number" th:text="${shipper.totalDeliveries}">0</p>
        </div>
        <div class="stat-card">
            <h3>Th√†nh c√¥ng</h3>
            <p class="stat-number text-success" th:text="${shipper.successfulDeliveries}">0</p>
        </div>
        <div class="stat-card">
            <h3>Th·∫•t b·∫°i</h3>
            <p class="stat-number text-danger" th:text="${shipper.failedDeliveries}">0</p>
        </div>
    </div>

    <div class="section">
        <h2>ƒê∆°n h√†ng ch·ªù l·∫•y</h2>
        <table>
            <thead>
            <tr>
                <th>M√£ ƒë∆°n</th>
                <th>Ng∆∞·ªùi g·ª≠i</th>
                <th>Ng∆∞·ªùi nh·∫≠n</th>
                <th>ƒê·ªãa ch·ªâ nh·∫≠n</th>
                <th>Thao t√°c</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="shipment : ${pendingShipments}">
                <td th:text="${shipment.order.orderCode}"></td>
                <td th:text="${shipment.order.senderName}"></td>
                <td th:text="${shipment.order.recipientName}"></td>
                <td th:text="${shipment.order.recipientAddress}"></td>
                <td><a th:href="@{/shipper/shipments/{id}(id=${shipment.id})}" class="btn-sm">Chi ti·∫øt</a></td>
            </tr>
            </tbody>
        </table>
    </div>

    <div class="section">
        <h2>ƒê∆°n ƒëang giao</h2>
        <table>
            <thead>
            <tr>
                <th>M√£ giao h√†ng</th>
                <th>M√£ ƒë∆°n</th>
                <th>Ng∆∞·ªùi nh·∫≠n</th>
                <th>SƒêT</th>
                <th>Thao t√°c</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="shipment : ${inTransitShipments}">
                <td th:text="${shipment.shipmentCode}"></td>
                <td th:text="${shipment.order.orderCode}"></td>
                <td th:text="${shipment.order.recipientName}"></td>
                <td th:text="${shipment.order.recipientPhone}"></td>
                <td><a th:href="@{/shipper/shipments/{id}(id=${shipment.id})}" class="btn-sm">Chi ti·∫øt</a></td>
            </tr>
            </tbody>
        </table>
    </div>
</div>

<!-- WebSocket Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
<script th:inline="javascript">
    // ‚úÖ FIX: L·∫•y t·ª´ shipper.user.id
    const userId = /*[[${shipper.user != null ? shipper.user.id : 0}]]*/ 0;
    const shipperName = /*[[${shipper.name}]]*/ '';

    if (userId > 0) {
        // WebSocket Connection
        const socket = new SockJS('/ws');
        const stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('‚úÖ WebSocket Connected for Shipper:', shipperName);
            
            // Subscribe to shipper notifications
            stompClient.subscribe('/topic/notifications/SHIPPER/' + userId, function(message) {
                const notification = JSON.parse(message.body);
                console.log('üì¨ New notification:', notification);
                
                showNotification(notification);
                updateUnreadCount();
            });
        });

        function showNotification(notif) {
            if (confirm('üì¨ ' + notif.message + '\n\nXem ngay?')) {
                if (notif.order) {
                    window.location.href = '/shipper/orders/' + notif.order.id;
                }
            }
        }

        function updateUnreadCount() {
            fetch('/api/notifications/SHIPPER/' + userId + '/count')
                .then(r => r.json())
                .then(data => {
                    const badge = document.querySelector('.notification-badge');
                    if (badge && data.count) {
                        badge.textContent = data.count;
                        badge.style.display = 'inline';
                    }
                })
                .catch(err => console.error('Update count failed:', err));
        }

        // Request notification permission
        if (Notification.permission === "default") {
            Notification.requestPermission();
        }
    } else {
        console.warn('‚ö†Ô∏è No user ID found - WebSocket disabled');
    }
</script>
</body>
</html>