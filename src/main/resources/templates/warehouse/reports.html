<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>B√°o c√°o kho h√†ng</title>
	<link rel="stylesheet" th:href="@{/css/warehouse.css}">
	<style>
		.report-container {
			max-width: 1600px;
			margin: 0 auto;
		}

		.report-header {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 30px;
			border-radius: 15px;
			margin-bottom: 30px;
			box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
		}

		.report-header h1 {
			margin: 0 0 10px 0;
			font-size: 32px;
		}

		.report-header p {
			margin: 0;
			opacity: 0.9;
		}

		.filter-section {
			background: white;
			padding: 25px;
			border-radius: 15px;
			box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
			margin-bottom: 30px;
		}

		.filter-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin-bottom: 20px;
		}

		.filter-item {
			display: flex;
			flex-direction: column;
		}

		.filter-item label {
			font-weight: 600;
			color: #2c3e50;
			margin-bottom: 8px;
			font-size: 14px;
		}

		.filter-item input,
		.filter-item select {
			padding: 12px 15px;
			border: 2px solid #e0e0e0;
			border-radius: 8px;
			font-size: 14px;
			transition: all 0.3s;
		}

		.filter-item input:focus,
		.filter-item select:focus {
			border-color: #667eea;
			outline: none;
			box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
		}

		.quick-reports {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 15px;
			margin-top: 20px;
		}

		.quick-report-btn {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			padding: 15px 20px;
			border: none;
			border-radius: 10px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s;
			display: flex;
			align-items: center;
			justify-content: center;
			gap: 8px;
		}

		.quick-report-btn:hover {
			transform: translateY(-2px);
			box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
		}

		.stats-overview {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
			gap: 20px;
			margin-bottom: 30px;
		}

		.stat-box {
			background: white;
			padding: 25px;
			border-radius: 15px;
			box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
			position: relative;
			overflow: hidden;
		}

		.stat-box::before {
			content: '';
			position: absolute;
			top: 0;
			left: 0;
			width: 4px;
			height: 100%;
			background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
		}

		.stat-box h4 {
			color: #7f8c8d;
			font-size: 13px;
			font-weight: 600;
			text-transform: uppercase;
			letter-spacing: 0.5px;
			margin: 0 0 10px 0;
		}

		.stat-box .value {
			font-size: 32px;
			font-weight: 700;
			color: #2c3e50;
			margin: 0;
		}

		.stat-box .change {
			font-size: 12px;
			margin-top: 8px;
			font-weight: 600;
		}

		.change.positive {
			color: #27ae60;
		}

		.change.negative {
			color: #e74c3c;
		}

		.chart-section {
			background: white;
			padding: 25px;
			border-radius: 15px;
			box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
			margin-bottom: 30px;
		}

		.chart-section h3 {
			color: #2c3e50;
			margin: 0 0 20px 0;
			font-size: 20px;
			border-bottom: 3px solid #667eea;
			padding-bottom: 10px;
		}

		.chart-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
			gap: 25px;
		}

		.chart-container {
			background: #f8f9fa;
			padding: 20px;
			border-radius: 10px;
			min-height: 300px;
		}

		.reports-table {
			background: white;
			border-radius: 15px;
			box-shadow: 0 2px 15px rgba(0, 0, 0, 0.08);
			overflow: hidden;
		}

		.table-header {
			padding: 20px 25px;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.table-header h3 {
			margin: 0;
			font-size: 20px;
		}

		.table-actions {
			display: flex;
			gap: 10px;
		}

		.btn-export {
			background: white;
			color: #667eea;
			padding: 8px 16px;
			border: none;
			border-radius: 6px;
			font-weight: 600;
			cursor: pointer;
			transition: all 0.3s;
		}

		.btn-export:hover {
			background: #f0f0f0;
		}

		.data-table {
			width: 100%;
			border-collapse: collapse;
		}

		.data-table thead {
			background: #f8f9fa;
		}

		.data-table th {
			padding: 15px;
			text-align: left;
			font-weight: 600;
			color: #2c3e50;
			border-bottom: 2px solid #e0e0e0;
			font-size: 13px;
			text-transform: uppercase;
			letter-spacing: 0.5px;
		}

		.data-table td {
			padding: 15px;
			border-bottom: 1px solid #f0f0f0;
			color: #555;
		}

		.data-table tbody tr {
			transition: all 0.2s;
		}

		.data-table tbody tr:hover {
			background: #f8f9fa;
		}

		.report-badge {
			padding: 6px 12px;
			border-radius: 20px;
			font-size: 12px;
			font-weight: 600;
			display: inline-block;
		}

		.badge-daily {
			background: #e3f2fd;
			color: #1976d2;
		}

		.badge-weekly {
			background: #f3e5f5;
			color: #7b1fa2;
		}

		.badge-monthly {
			background: #e8f5e9;
			color: #388e3c;
		}

		.badge-quarterly {
			background: #fff3e0;
			color: #f57c00;
		}

		.badge-yearly {
			background: #fce4ec;
			color: #c2185b;
		}

		.action-buttons {
			display: flex;
			gap: 8px;
		}

		.btn-icon {
			width: 32px;
			height: 32px;
			border: none;
			border-radius: 6px;
			cursor: pointer;
			transition: all 0.2s;
			display: flex;
			align-items: center;
			justify-content: center;
		}

		.btn-view {
			background: #e3f2fd;
			color: #1976d2;
		}

		.btn-view:hover {
			background: #1976d2;
			color: white;
		}

		.btn-delete {
			background: #ffebee;
			color: #c62828;
		}

		.btn-delete:hover {
			background: #c62828;
			color: white;
		}

		.btn-print {
			background: #f3e5f5;
			color: #7b1fa2;
		}

		.btn-print:hover {
			background: #7b1fa2;
			color: white;
		}

		.empty-state {
			text-align: center;
			padding: 60px 20px;
			color: #95a5a6;
		}

		.empty-state svg {
			width: 120px;
			height: 120px;
			margin-bottom: 20px;
			opacity: 0.3;
		}

		.empty-state h3 {
			color: #7f8c8d;
			margin-bottom: 10px;
		}

		.pagination {
			display: flex;
			justify-content: center;
			align-items: center;
			gap: 10px;
			padding: 20px;
		}

		.page-btn {
			padding: 8px 12px;
			border: 2px solid #e0e0e0;
			background: white;
			border-radius: 6px;
			cursor: pointer;
			transition: all 0.2s;
			font-weight: 600;
		}

		.page-btn:hover {
			border-color: #667eea;
			color: #667eea;
		}

		.page-btn.active {
			background: #667eea;
			color: white;
			border-color: #667eea;
		}

		@media (max-width: 768px) {

			.filter-grid,
			.quick-reports,
			.stats-overview,
			.chart-grid {
				grid-template-columns: 1fr;
			}
		}
	</style>
</head>

<body>
	<div th:replace="~{fragments/warehouse-header :: header}"></div>

	<div class="container report-container">
		<div class="report-header">
			<h1>üìä B√°o c√°o Kho H√†ng</h1>
			<p>Theo d√µi v√† ph√¢n t√≠ch ho·∫°t ƒë·ªông kho h√†ng</p>
		</div>

		<div th:if="${success}" class="alert success" th:text="${success}"></div>
		<div th:if="${error}" class="alert error" th:text="${error}"></div>

		<!-- Filter Section -->
		<div class="filter-section">
			<h3 style="margin: 0 0 20px 0; color: #2c3e50;">üîç T·∫°o B√°o C√°o M·ªõi</h3>
			<form th:action="@{/warehouse/reports/generate}" method="post">
				<div class="filter-grid">
					<div class="filter-item">
						<label>Lo·∫°i b√°o c√°o</label>
						<select name="reportType" required>
							<option value="">-- Ch·ªçn lo·∫°i --</option>
							<option value="DAILY">Ng√†y</option>
							<option value="WEEKLY">Tu·∫ßn</option>
							<option value="MONTHLY">Th√°ng</option>
							<option value="QUARTERLY">Qu√Ω</option>
							<option value="YEARLY">NƒÉm</option>
						</select>
					</div>
					<div class="filter-item">
						<label>T·ª´ ng√†y</label>
						<input type="datetime-local" name="startDate" required>
					</div>
					<div class="filter-item">
						<label>ƒê·∫øn ng√†y</label>
						<input type="datetime-local" name="endDate" required>
					</div>
					<div class="filter-item">
						<label style="opacity: 0;">Action</label>
						<button type="submit" class="btn-primary" style="height: 46px;">T·∫°o b√°o c√°o</button>
					</div>
				</div>
				<div class="filter-item">
					<label>Ghi ch√∫ (t√πy ch·ªçn)</label>
					<textarea name="notes" rows="2"
						style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit;"></textarea>
				</div>
			</form>

			<div class="quick-reports">
				<form th:action="@{/warehouse/reports/generate-daily}" method="post" style="display: contents;">
					<input type="hidden" name="date" th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd''T''HH:mm')}">
					<button type="submit" class="quick-report-btn">
						üìÖ B√°o c√°o h√¥m nay
					</button>
				</form>
				<form th:action="@{/warehouse/reports/generate-weekly}" method="post" style="display: contents;">
					<input type="hidden" name="weekStart"
						th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd''T''HH:mm')}">
					<button type="submit" class="quick-report-btn">
						üìä B√°o c√°o tu·∫ßn n√†y
					</button>
				</form>
				<form th:action="@{/warehouse/reports/generate-monthly}" method="post" style="display: contents;">
					<input type="hidden" name="month"
						th:value="${#temporals.format(#temporals.createNow(), 'yyyy-MM-dd''T''HH:mm')}">
					<button type="submit" class="quick-report-btn">
						üìà B√°o c√°o th√°ng n√†y
					</button>
				</form>
			</div>
		</div>

		<!-- Statistics Overview -->
		<div class="stats-overview">
			<div class="stat-box">
				<h4>T·ªïng phi·∫øu nh·∫≠p</h4>
				<p class="value" th:text="${reports.isEmpty() ? 0 : reports.get(0).totalInboundReceipts}">0</p>
				<p class="change positive">‚Üë K·ª≥ g·∫ßn nh·∫•t</p>
			</div>
			<div class="stat-box">
				<h4>T·ªïng phi·∫øu xu·∫•t</h4>
				<p class="value" th:text="${reports.isEmpty() ? 0 : reports.get(0).totalOutboundReceipts}">0</p>
				<p class="change positive">‚Üë K·ª≥ g·∫ßn nh·∫•t</p>
			</div>
			<div class="stat-box">
				<h4>T·ªìn kho hi·ªán t·∫°i</h4>
				<p class="value" th:text="${reports.isEmpty() ? 0 : reports.get(0).closingStock}">0</p>
				<p class="change">ƒê∆°n v·ªã: ki·ªán</p>
			</div>
			<div class="stat-box">
				<h4>T·ª∑ l·ªá s·ª≠ d·ª•ng</h4>
				<p class="value"
					th:text="${reports.isEmpty() ? '0.0' : #numbers.formatDecimal(reports.get(0).utilizationRate, 1, 1)} + '%'">
					0%</p>
				<p class="change"
					th:classappend="${reports.isEmpty() ? '' : (reports.get(0).utilizationRate > 70 ? 'positive' : 'negative')}">
					C√¥ng su·∫•t kho
				</p>
			</div>
		</div>

		<!-- Charts Section -->
		<div class="chart-section">
			<h3>üìâ Bi·ªÉu ƒê·ªì Ph√¢n T√≠ch</h3>
			<div class="chart-grid">
				<div class="chart-container">
					<canvas id="inboundOutboundChart"></canvas>
				</div>
				<div class="chart-container">
					<canvas id="utilizationChart"></canvas>
				</div>
			</div>
		</div>

		<!-- Reports Table -->
		<div class="reports-table">
			<div class="table-header">
				<h3>üìã Danh S√°ch B√°o C√°o</h3>
				<div class="table-actions">
					<button class="btn-export" onclick="exportToExcel()">üì• Xu·∫•t Excel</button>
					<button class="btn-export" onclick="window.print()">üñ®Ô∏è In</button>
				</div>
			</div>

			<table class="data-table">
				<thead>
					<tr>
						<th>Lo·∫°i BC</th>
						<th>Th·ªùi gian</th>
						<th>T·ªìn ƒë·∫ßu k·ª≥</th>
						<th>SL nh·∫≠p</th>
						<th>SL xu·∫•t</th>
						<th>T·ªìn cu·ªëi k·ª≥</th>
						<th>T·ª∑ l·ªá SD (%)</th>
						<th>Ng∆∞·ªùi t·∫°o</th>
						<th>Ng√†y t·∫°o</th>
						<th>Thao t√°c</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="report : ${reports}">
						<td>
							<span th:class="'report-badge badge-' + ${#strings.toLowerCase(report.reportType)}"
								th:text="${report.reportType}"></span>
						</td>
						<td>
							<div style="font-size: 13px; color: #555;">
								<div th:text="${#temporals.format(report.startDate, 'dd/MM/yyyy')}"></div>
								<div style="color: #95a5a6;">ƒë·∫øn</div>
								<div th:text="${#temporals.format(report.endDate, 'dd/MM/yyyy')}"></div>
							</div>
						</td>
						<td th:text="${report.openingStock}">0</td>
						<td>
							<span style="color: #27ae60; font-weight: 600;"
								th:text="'+' + ${report.totalInboundQuantity}"></span>
						</td>
						<td>
							<span style="color: #e74c3c; font-weight: 600;"
								th:text="'-' + ${report.totalOutboundQuantity}"></span>
						</td>
						<td>
							<strong th:text="${report.closingStock}">0</strong>
						</td>
						<td>
							<div style="display: flex; align-items: center; gap: 8px;">
								<div
									style="flex: 1; background: #f0f0f0; height: 8px; border-radius: 4px; overflow: hidden;">
									<div
										th:style="'width: ' + ${report.utilizationRate} + '%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s;'">
									</div>
								</div>
								<span th:text="${#numbers.formatDecimal(report.utilizationRate, 1, 1)} + '%'"
									style="font-weight: 600; min-width: 50px;">0%</span>
							</div>
						</td>
						<td th:text="${report.createdBy.fullName}"></td>
						<td th:text="${#temporals.format(report.createdAt, 'dd/MM/yyyy HH:mm')}"></td>
						<td>
							<div class="action-buttons">
								<a th:href="@{/warehouse/reports/{id}(id=${report.id})}" class="btn-icon btn-view"
									title="Xem chi ti·∫øt">üëÅÔ∏è</a>
								<button class="btn-icon btn-print" th:onclick="'printReport(' + ${report.id} + ')'"
									title="In">üñ®Ô∏è</button>
								<form th:action="@{/warehouse/reports/{id}/delete(id=${report.id})}" method="post"
									style="display: contents;"
									onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√°o c√°o n√†y?')">
									<button type="submit" class="btn-icon btn-delete" title="X√≥a">üóëÔ∏è</button>
								</form>
							</div>
						</td>
					</tr>
				</tbody>
			</table>

			<div th:if="${reports.isEmpty()}" class="empty-state">
				<svg viewBox="0 0 24 24" fill="currentColor">
					<path
						d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z" />
				</svg>
				<h3>Ch∆∞a c√≥ b√°o c√°o n√†o</h3>
				<p>T·∫°o b√°o c√°o m·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu ph√¢n t√≠ch ho·∫°t ƒë·ªông kho</p>
			</div>

			<div class="pagination" th:if="${!reports.isEmpty()}">
				<button class="page-btn">‚Äπ</button>
				<button class="page-btn active">1</button>
				<button class="page-btn">2</button>
				<button class="page-btn">3</button>
				<button class="page-btn">‚Ä∫</button>
			</div>
		</div>
	</div>

	<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
	<script th:inline="javascript">
		const reports = /*[[${reports}]]*/[];

		// Inbound/Outbound Chart
		const ctx1 = document.getElementById('inboundOutboundChart');
		if (ctx1) {
			new Chart(ctx1, {
				type: 'line',
				data: {
					labels: reports.map(r => new Date(r.startDate).toLocaleDateString('vi-VN')),
					datasets: [{
						label: 'Nh·∫≠p kho',
						data: reports.map(r => r.totalInboundQuantity),
						borderColor: '#27ae60',
						backgroundColor: 'rgba(39, 174, 96, 0.1)',
						tension: 0.4
					}, {
						label: 'Xu·∫•t kho',
						data: reports.map(r => r.totalOutboundQuantity),
						borderColor: '#e74c3c',
						backgroundColor: 'rgba(231, 76, 60, 0.1)',
						tension: 0.4
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					plugins: {
						legend: { position: 'top' },
						title: { display: true, text: 'Bi·ªÉu ƒë·ªì Nh·∫≠p/Xu·∫•t Kho' }
					}
				}
			});
		}

		// Utilization Chart
		const ctx2 = document.getElementById('utilizationChart');
		if (ctx2) {
			new Chart(ctx2, {
				type: 'bar',
				data: {
					labels: reports.map(r => new Date(r.startDate).toLocaleDateString('vi-VN')),
					datasets: [{
						label: 'T·ª∑ l·ªá s·ª≠ d·ª•ng (%)',
						data: reports.map(r => r.utilizationRate),
						backgroundColor: 'rgba(102, 126, 234, 0.8)',
						borderColor: '#667eea',
						borderWidth: 2
					}]
				},
				options: {
					responsive: true,
					maintainAspectRatio: false,
					scales: {
						y: { beginAtZero: true, max: 100 }
					},
					plugins: {
						legend: { position: 'top' },
						title: { display: true, text: 'T·ª∑ l·ªá S·ª≠ D·ª•ng Kho' }
					}
				}
			});
		}

		function exportToExcel() {
			window.location.href = '/warehouse/reports/export/excel';
		}

		function printReport(id) {
			window.open('/warehouse/reports/' + id + '/print', '_blank');
		}
	</script>
</body>

</html>