<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
	<meta charset="UTF-8">
	<title>Chi ti·∫øt ƒë∆°n h√†ng</title>
	<link rel="stylesheet" th:href="@{/css/warehouse.css}">
</head>

<body>
	<div th:replace="~{fragments/warehouse-header :: header}"></div>
	<div class="container">
		<div class="page-header">
			<h1>Chi ti·∫øt ƒë∆°n h√†ng</h1>
			<div>
				<a th:href="@{/warehouse/orders}" class="btn-secondary">Quay l·∫°i</a>
			</div>
		</div>
		<div th:if="${success}" class="alert success" th:text="${success}"></div>
		<div th:if="${error}" class="alert error" th:text="${error}"></div>

		<div class="detail-grid">
			<div class="detail-card">
				<h3>Th√¥ng tin ƒë∆°n h√†ng</h3>
				<p>
					<strong>M√£ ƒë∆°n:</strong> <span th:text="${order.orderCode}"></span>
				</p>
				<p>
					<strong>Tr·∫°ng th√°i:</strong> <span th:class="'badge badge-' + ${order.status}"
						th:text="${order.status}"></span>
				</p>
				<p>
					<strong>Ph√≠ v·∫≠n chuy·ªÉn:</strong> <span
						th:text="${#numbers.formatDecimal(order.shipmentFee, 0, 'COMMA', 0, 'POINT')} + ' ƒë'"></span>
				</p>
				<p>
					<strong>Ghi ch√∫:</strong> <span th:text="${order.notes}"></span>
				</p>
			</div>

			<div class="detail-card">
				<h3>Th√¥ng tin kho</h3>
				<p>
					<strong>Kho xu·∫•t:</strong> <span
						th:text="${order.warehouse != null ? order.warehouse.name + ' (' + order.warehouse.code + ')' : '-'}"></span>
				</p>
				<p>
					<strong>Kho ƒë√≠ch:</strong> <span
						th:text="${order.destinationWarehouse != null ? order.destinationWarehouse.name + ' (' + order.destinationWarehouse.code + ')' : '-'}"></span>
				</p>
			</div>

			<div class="detail-card">
				<h3>Ng∆∞·ªùi g·ª≠i</h3>
				<p>
					<strong>T√™n:</strong> <span th:text="${order.senderName}"></span>
				</p>
				<p>
					<strong>SƒêT:</strong> <span th:text="${order.senderPhone}"></span>
				</p>
				<p>
					<strong>ƒê·ªãa ch·ªâ:</strong> <span th:text="${order.senderAddress}"></span>
				</p>
			</div>

			<div class="detail-card">
				<h3>Ng∆∞·ªùi nh·∫≠n</h3>
				<p>
					<strong>T√™n:</strong> <span th:text="${order.recipientName}"></span>
				</p>
				<p>
					<strong>SƒêT:</strong> <span th:text="${order.recipientPhone}"></span>
				</p>
				<p>
					<strong>ƒê·ªãa ch·ªâ:</strong> <span th:text="${order.recipientAddress}"></span>
				</p>
			</div>
		</div>

		<!-- ‚úÖ S·ª¨A: Ki·ªÉm tra shipment null v√† status -->
		<div class="section" th:if="${shipment == null && order.status.name() == 'CHO_GIAO'}"
			style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-top: 20px;">
			<h3 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è ƒê∆°n h√†ng ch∆∞a c√≥ Shipment</h3>
			<p style="color: #856404; margin-bottom: 15px;">Vui l√≤ng t·∫°o shipment ƒë·ªÉ shipper c√≥ th·ªÉ nh·∫≠n v√† giao h√†ng.
			</p>
			<form th:action="@{/warehouse/orders/{id}/create-shipment(id=${order.id})}" method="post"
				onsubmit="return confirm('X√°c nh·∫≠n t·∫°o shipment cho ƒë∆°n h√†ng n√†y?');">
				<button type="submit" class="btn-primary" style="font-size: 16px; padding: 12px 24px;">üì¶ T·∫°o Shipment
					Ngay</button>
			</form>
		</div>

		<div class="section" th:if="${shipmentLegs != null && !shipmentLegs.isEmpty()}">
			<h3>H√†nh tr√¨nh v·∫≠n chuy·ªÉn</h3>
			<table>
				<thead>
					<tr>
						<th>Ch·∫∑ng</th>
						<th>T·ª´ kho</th>
						<th>ƒê·∫øn kho</th>
						<th>Shipper</th>
						<th>Kho·∫£ng c√°ch (km)</th>
						<th>Th·ªùi gian d·ª± ki·∫øn (h)</th>
						<th>Tr·∫°ng th√°i</th>
						<th>Ch·∫∑ng cu·ªëi</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="leg : ${shipmentLegs}">
						<td th:text="${leg.legOrder}"></td>
						<td th:text="${leg.fromWarehouse.name + ' (' + leg.fromWarehouse.code + ')'}"></td>
						<td
							th:text="${leg.toWarehouse != null ? leg.toWarehouse.name + ' (' + leg.toWarehouse.code + ')' : 'Kh√°ch h√†ng'}">
						</td>
						<td th:text="${leg.shipper != null ? leg.shipper.name : 'Ch∆∞a ph√¢n'}"></td>
						<td th:text="${leg.distanceKm}"></td>
						<td th:text="${leg.estimatedHours}"></td>
						<td><span th:class="'badge badge-' + ${leg.status}" th:text="${leg.status}"></span></td>
						<td><span th:class="${leg.isFinalLeg ? 'badge badge-success' : 'badge badge-secondary'}"
								th:text="${leg.isFinalLeg ? 'Cu·ªëi' : 'Trung gian'}"></span></td>
					</tr>
				</tbody>
			</table>
		</div>

		<!-- ‚úÖ S·ª¨A: Ki·ªÉm tra status v√† shipper null -->
		<div class="section" th:if="${order.status.name() == 'CHO_GIAO' && order.shipper == null}">
			<h3>Ph√¢n c√¥ng Shipper (Override)</h3>
			<form th:action="@{/warehouse/orders/{id}/assign-shipper(id=${order.id})}" method="post"
				class="inline-form">
				<select name="shipperId" required>
					<option value="">-- Ch·ªçn Shipper --</option>
					<option th:each="shipper : ${availableShippers}" th:value="${shipper.id}"
						th:text="${shipper.name + ' (' + shipper.code + ')'}"></option>
				</select>
				<button type="submit" class="btn-primary">Ph√¢n c√¥ng</button>
			</form>
		</div>

		<div class="section" th:if="${order.shipper != null}">
			<h3>Shipper ƒë∆∞·ª£c ph√¢n c√¥ng</h3>
			<p>
				<strong>T√™n:</strong> <span th:text="${order.shipper.name}"></span>
			</p>
			<p>
				<strong>M√£:</strong> <span th:text="${order.shipper.code}"></span>
			</p>
			<p>
				<strong>SƒêT:</strong> <span th:text="${order.shipper.phone}"></span>
			</p>
		</div>

		<!-- Th√™m v√†o sau ph·∫ßn Shipper, tr∆∞·ªõc ph·∫ßn Packages -->

		<!-- SECTION: NH·∫¨P KHO & XU·∫§T KHO -->
		<div class="section" th:if="${order.status.name() == 'CHO_GIAO'}">
			<h3>üì¶ Qu·∫£n l√Ω nh·∫≠p/xu·∫•t kho</h3>

			<!-- N·∫øu ch∆∞a nh·∫≠p kho -->
			<div th:if="${!hasInboundReceipt}"
				style="background: #d1ecf1; padding: 20px; border-radius: 10px; border: 2px solid #17a2b8; margin-bottom: 15px;">
				<h4 style="color: #0c5460; margin-bottom: 10px;">
					<i class="fas fa-warehouse"></i> ƒê∆°n h√†ng ch∆∞a ƒë∆∞·ª£c nh·∫≠p kho
				</h4>
				<p style="color: #0c5460; margin-bottom: 15px;">
					Vui l√≤ng nh·∫≠p kho tr∆∞·ªõc khi xu·∫•t h√†ng cho shipper.
				</p>
				<a th:href="@{/warehouse/inbound/receive-order/{orderId}(orderId=${order.id})}" class="btn-primary"
					style="font-size: 16px; padding: 12px 24px;">
					<i class="fas fa-download"></i> Nh·∫≠p kho ngay
				</a>
			</div>

			<!-- N·∫øu ƒë√£ nh·∫≠p kho, hi·ªÉn th·ªã th√¥ng tin -->
			<div th:if="${hasInboundReceipt}"
				style="background: #d4edda; padding: 20px; border-radius: 10px; border: 2px solid #28a745; margin-bottom: 15px;">
				<h4 style="color: #155724; margin-bottom: 10px;">
					<i class="fas fa-check-circle"></i> ƒê√£ nh·∫≠p kho
				</h4>
				<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
					<div th:each="receipt : ${inboundReceipts}">
						<p style="margin: 5px 0; color: #155724;">
							<strong>M√£ phi·∫øu:</strong> <span th:text="${receipt.receiptCode}"></span>
						</p>
						<p style="margin: 5px 0; color: #155724;">
							<strong>Ng√†y nh·∫≠p:</strong> <span
								th:text="${#temporals.format(receipt.receivedDate, 'dd/MM/yyyy HH:mm')}"></span>
						</p>
					</div>
				</div>

				<!-- Hi·ªÉn th·ªã t·ªìn kho -->
				<div style="background: white; padding: 15px; border-radius: 8px; margin-top: 15px;">
					<h5 style="margin-bottom: 10px;">T·ªìn kho hi·ªán t·∫°i:</h5>
					<table style="width: 100%; font-size: 14px;">
						<thead>
							<tr>
								<th>M√£ ki·ªán</th>
								<th>T·ªïng SL</th>
								<th>ƒê√£ xu·∫•t</th>
								<th>C√≤n l·∫°i</th>
							</tr>
						</thead>
						<tbody>
							<tr th:each="inv : ${inventories}" th:if="${inv != null}">
								<td th:text="${inv.packageItem.packageCode}"></td>
								<td th:text="${inv.quantity}"></td>
								<td th:text="${inv.deliveredQuantity}"></td>
								<td><strong th:text="${inv.remainingQuantity}"></strong></td>
							</tr>
						</tbody>
					</table>
				</div>

				<!-- N·∫øu ch∆∞a xu·∫•t kho -->
				<div th:if="${!hasOutboundReceipt}" style="margin-top: 20px;">
					<h4 style="color: #155724; margin-bottom: 10px;">
						<i class="fas fa-truck"></i> Xu·∫•t kho cho Shipper
					</h4>
					<p style="color: #155724; margin-bottom: 15px;">
						H√†ng ƒë√£ s·∫µn s√†ng ƒë·ªÉ xu·∫•t kho v√† giao cho shipper.
					</p>
					<a th:href="@{/warehouse/outbound/issue-order/{orderId}(orderId=${order.id})}" class="btn-primary"
						style="font-size: 16px; padding: 12px 24px;">
						<i class="fas fa-shipping-fast"></i> Xu·∫•t kho ngay
					</a>
				</div>

				<!-- N·∫øu ƒë√£ xu·∫•t kho -->
				<div th:if="${hasOutboundReceipt}"
					style="background: white; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #ffc107;">
					<h4 style="color: #856404; margin-bottom: 10px;">
						<i class="fas fa-check-double"></i> ƒê√£ xu·∫•t kho
					</h4>
					<div th:each="receipt : ${outboundReceipts}">
						<p style="margin: 5px 0; color: #856404;">
							<strong>M√£ phi·∫øu:</strong> <span th:text="${receipt.receiptCode}"></span>
						</p>
						<p style="margin: 5px 0; color: #856404;">
							<strong>Shipper:</strong> <span
								th:text="${receipt.shipper != null ? receipt.shipper.name : '-'}"></span>
						</p>
						<p style="margin: 5px 0; color: #856404;">
							<strong>Ng√†y xu·∫•t:</strong> <span
								th:text="${#temporals.format(receipt.issuedDate, 'dd/MM/yyyy HH:mm')}"></span>
						</p>
					</div>
				</div>
			</div>
		</div>

		<div class="section">
			<h3>Danh s√°ch ki·ªán h√†ng</h3>
			<a th:href="@{/warehouse/orders/{id}/packages/add(id=${order.id})}" class="btn-secondary mb-3">Th√™m ki·ªán</a>
			<table>
				<thead>
					<tr>
						<th>M√£ ki·ªán</th>
						<th>M√¥ t·∫£</th>
						<th>Tr·ªçng l∆∞·ª£ng (kg)</th>
						<th>K√≠ch th∆∞·ªõc (cm)</th>
						<th>Tr·∫°ng th√°i</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="pkg : ${packages}">
						<td th:text="${pkg.packageCode}"></td>
						<td th:text="${pkg.description}"></td>
						<td th:text="${pkg.weight}"></td>
						<td th:text="${pkg.length} + ' x ' + ${pkg.width} + ' x ' + ${pkg.height}"></td>
						<td><span th:class="'badge badge-' + ${pkg.status}" th:text="${pkg.status}"></span></td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="section">
			<h3>C·∫≠p nh·∫≠t tr·∫°ng th√°i</h3>
			<form th:action="@{/warehouse/orders/{id}/update-status(id=${order.id})}" method="post" class="inline-form">
				<select name="status" required>
					<option value="CHO_GIAO">Ch·ªù giao</option>
					<option value="DANG_GIAO">ƒêang giao</option>
					<option value="HOAN_THANH">Ho√†n th√†nh</option>
					<option value="THAT_BAI">Th·∫•t b·∫°i</option>
					<option value="HUY">H·ªßy</option>
				</select>
				<button type="submit" class="btn-primary">C·∫≠p nh·∫≠t</button>
			</form>
		</div>
	</div>
</body>

</html>