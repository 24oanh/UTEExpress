<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>Chi ti·∫øt ƒë∆°n h√†ng</title>
<link rel="stylesheet" th:href="@{/css/warehouse.css}">
</head>
<body>
	<div th:replace="~{fragments/warehouse-header :: header}"></div>
	<div class="container">
		<div class="page-header">
			<h1>Chi ti·∫øt ƒë∆°n h√†ng</h1>
			<div>
				<a th:href="@{/warehouse/orders/{id}/edit(id=${order.id})}"
					class="btn-secondary">S·ª≠a</a> <a th:href="@{/warehouse/orders}"
					class="btn-secondary">Quay l·∫°i</a>
			</div>
		</div>
		<div th:if="${success}" class="alert success" th:text="${success}"></div>
		<div th:if="${error}" class="alert error" th:text="${error}"></div>

		<div class="detail-grid">
			<div class="detail-card">
				<h3>Th√¥ng tin ƒë∆°n h√†ng</h3>
				<p>
					<strong>M√£ ƒë∆°n:</strong> <span th:text="${order.orderCode}"></span>
				</p>
				<p>
					<strong>Tr·∫°ng th√°i:</strong> <span
						th:class="'badge badge-' + ${order.status}"
						th:text="${order.status}"></span>
				</p>
				<p>
					<strong>Ph√≠ v·∫≠n chuy·ªÉn:</strong> <span
						th:text="${#numbers.formatDecimal(order.shipmentFee, 0, 'COMMA', 0, 'POINT')} + ' ƒë'"></span>
				</p>
				<p>
					<strong>Ghi ch√∫:</strong> <span th:text="${order.notes}"></span>
				</p>
			</div>
			<div class="section"
				th:if="${shipment == null && order.status.name() == 'CHO_GIAO'}"
				style="background: #fff3cd; padding: 20px; border-radius: 10px; border: 2px solid #ffc107; margin-top: 20px;">
				<h3 style="color: #856404; margin-bottom: 15px;">‚ö†Ô∏è ƒê∆°n h√†ng
					ch∆∞a c√≥ Shipment</h3>
				<p style="color: #856404; margin-bottom: 15px;">Vui l√≤ng t·∫°o
					shipment ƒë·ªÉ shipper c√≥ th·ªÉ nh·∫≠n v√† giao h√†ng.</p>
				<form
					th:action="@{/warehouse/orders/{id}/create-shipment(id=${order.id})}"
					method="post"
					onsubmit="return confirm('X√°c nh·∫≠n t·∫°o shipment cho ƒë∆°n h√†ng n√†y?');">
					<button type="submit" class="btn-primary"
						style="font-size: 16px; padding: 12px 24px;">üì¶ T·∫°o
						Shipment Ngay</button>
				</form>
			</div>


			<div class="detail-card">
				<h3>Th√¥ng tin kho</h3>
				<p>
					<strong>Kho xu·∫•t:</strong> <span
						th:text="${order.warehouse != null ? order.warehouse.name + ' (' + order.warehouse.code + ')' : '-'}"></span>
				</p>
				<p>
					<strong>Kho ƒë√≠ch:</strong> <span
						th:text="${order.destinationWarehouse != null ? order.destinationWarehouse.name + ' (' + order.destinationWarehouse.code + ')' : '-'}"></span>
				</p>
			</div>

			<div class="detail-card">
				<h3>Ng∆∞·ªùi g·ª≠i</h3>
				<p>
					<strong>T√™n:</strong> <span th:text="${order.senderName}"></span>
				</p>
				<p>
					<strong>SƒêT:</strong> <span th:text="${order.senderPhone}"></span>
				</p>
				<p>
					<strong>ƒê·ªãa ch·ªâ:</strong> <span th:text="${order.senderAddress}"></span>
				</p>
			</div>

			<div class="detail-card">
				<h3>Ng∆∞·ªùi nh·∫≠n</h3>
				<p>
					<strong>T√™n:</strong> <span th:text="${order.recipientName}"></span>
				</p>
				<p>
					<strong>SƒêT:</strong> <span th:text="${order.recipientPhone}"></span>
				</p>
				<p>
					<strong>ƒê·ªãa ch·ªâ:</strong> <span th:text="${order.recipientAddress}"></span>
				</p>
			</div>
		</div>

		<div class="section"
			th:if="${shipmentLegs != null && !shipmentLegs.isEmpty()}">
			<h3>H√†nh tr√¨nh v·∫≠n chuy·ªÉn</h3>
			<table>
				<thead>
					<tr>
						<th>Ch·∫∑ng</th>
						<th>T·ª´ kho</th>
						<th>ƒê·∫øn kho</th>
						<th>Shipper</th>
						<th>Kho·∫£ng c√°ch (km)</th>
						<th>Th·ªùi gian d·ª± ki·∫øn (h)</th>
						<th>Tr·∫°ng th√°i</th>
						<th>Ch·∫∑ng cu·ªëi</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="leg : ${shipmentLegs}">
						<td th:text="${leg.legOrder}"></td>
						<td
							th:text="${leg.fromWarehouse.name + ' (' + leg.fromWarehouse.code + ')'}"></td>
						<td
							th:text="${leg.toWarehouse != null ? leg.toWarehouse.name + ' (' + leg.toWarehouse.code + ')' : 'Kh√°ch h√†ng'}"></td>
						<td
							th:text="${leg.shipper != null ? leg.shipper.name : 'Ch∆∞a ph√¢n'}"></td>
						<td th:text="${leg.distanceKm}"></td>
						<td th:text="${leg.estimatedHours}"></td>
						<td><span th:class="'badge badge-' + ${leg.status}"
							th:text="${leg.status}"></span></td>
						<td><span
							th:class="${leg.isFinalLeg ? 'badge badge-success' : 'badge badge-secondary'}"
							th:text="${leg.isFinalLeg ? 'Cu·ªëi' : 'Trung gian'}"></span></td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="section"
			th:if="${order.status == T(ltweb.entity.OrderStatus).CHO_GIAO && order.shipper == null}">
			<h3>Ph√¢n c√¥ng Shipper (Override)</h3>
			<form
				th:action="@{/warehouse/orders/{id}/assign-shipper(id=${order.id})}"
				method="post" class="inline-form">
				<select name="shipperId" required>
					<option value="">-- Ch·ªçn Shipper --</option>
					<option th:each="shipper : ${availableShippers}"
						th:value="${shipper.id}"
						th:text="${shipper.name + ' (' + shipper.code + ')'}"></option>
				</select>
				<button type="submit" class="btn-primary">Ph√¢n c√¥ng</button>
			</form>
		</div>

		<div class="section" th:if="${order.shipper != null}">
			<h3>Shipper ƒë∆∞·ª£c ph√¢n c√¥ng</h3>
			<p>
				<strong>T√™n:</strong> <span th:text="${order.shipper.name}"></span>
			</p>
			<p>
				<strong>M√£:</strong> <span th:text="${order.shipper.code}"></span>
			</p>
			<p>
				<strong>SƒêT:</strong> <span th:text="${order.shipper.phone}"></span>
			</p>
		</div>

		<div class="section">
			<h3>Danh s√°ch ki·ªán h√†ng</h3>
			<a th:href="@{/warehouse/orders/{id}/packages/add(id=${order.id})}"
				class="btn-secondary mb-3">Th√™m ki·ªán</a>
			<table>
				<thead>
					<tr>
						<th>M√£ ki·ªán</th>
						<th>M√¥ t·∫£</th>
						<th>Tr·ªçng l∆∞·ª£ng (kg)</th>
						<th>K√≠ch th∆∞·ªõc (cm)</th>
						<th>Tr·∫°ng th√°i</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="pkg : ${packages}">
						<td th:text="${pkg.packageCode}"></td>
						<td th:text="${pkg.description}"></td>
						<td th:text="${pkg.weight}"></td>
						<td
							th:text="${pkg.length} + ' x ' + ${pkg.width} + ' x ' + ${pkg.height}"></td>
						<td><span th:class="'badge badge-' + ${pkg.status}"
							th:text="${pkg.status}"></span></td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="section">
			<h3>C·∫≠p nh·∫≠t tr·∫°ng th√°i</h3>
			<form
				th:action="@{/warehouse/orders/{id}/update-status(id=${order.id})}"
				method="post" class="inline-form">
				<select name="status" required>
					<option value="CHO_GIAO">Ch·ªù giao</option>
					<option value="DANG_GIAO">ƒêang giao</option>
					<option value="HOAN_THANH">Ho√†n th√†nh</option>
					<option value="THAT_BAI">Th·∫•t b·∫°i</option>
					<option value="HUY">H·ªßy</option>
				</select>
				<button type="submit" class="btn-primary">C·∫≠p nh·∫≠t</button>
			</form>
		</div>
	</div>
</body>
</html>